<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SBS Kitchen - OPS</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Poppins:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --bg-dark: #1e1e24; --card-bg: #2b2b36; --accent: #FFD200; --text: #eaeaea; --green: #2ecc71; --red: #e74c3c; --blue: #3498db; }
        * { box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background: var(--bg-dark); color: var(--text); margin: 0; padding: 0; display: flex; height: 100vh; overflow: hidden; }
        
        .sidebar { width: 260px; background: #15151a; padding: 20px; display: flex; flex-direction: column; border-right: 1px solid #333; flex-shrink: 0; z-index: 100; }
        .brand { font-family: 'Bebas Neue'; font-size: 40px; color: var(--accent); margin-bottom: 40px; text-align: center; letter-spacing: 2px; }
        
        .menu-item { 
            padding: 15px; cursor: pointer; border-radius: 10px; margin-bottom: 10px; 
            font-weight: 600; transition: 0.2s; color: #888; display: flex; 
            align-items: center; gap: 10px; position: relative; 
        }
        .menu-item.active, .menu-item:hover { background: var(--card-bg); color: var(--accent); }
        .menu-icon { font-size: 20px; }

        /* --- ANIMASI KARTU HILANG --- */
        .fade-out {
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0;
            transform: scale(0.8);
            max-height: 0 !important;
            margin-bottom: 0 !important;
            padding-top: 0 !important;
            padding-bottom: 0 !important;
            border: none !important;
            overflow: hidden;
        }
        
        /* BADGE NOTIFIKASI */
        .nav-badge {
            position: absolute; top: 5px; right: 15px;
            background-color: var(--red); color: #fff;
            font-size: 10px; font-weight: 900;
            padding: 0; border-radius: 50%;
            width: 18px; height: 18px;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5); z-index: 10;
            border: 2px solid #fff;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }

        .main { flex: 1; padding: 20px; overflow-y: auto; position: relative; scroll-behavior: smooth; }
        .top-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .page-title { margin:0; font-family:'Bebas Neue'; color:var(--accent); font-size: 28px; }
        .header-actions { display: flex; gap: 15px; align-items: center; }
        
        /* TOMBOL AUDIO */
        #btn-audio { 
            background: #330000; border: 2px solid var(--red); border-radius: 50%; width: 44px; height: 44px; 
            cursor: pointer; font-size: 22px; display: flex; align-items: center; justify-content: center; 
            color: var(--red); transition: all 0.3s ease; outline: none; padding: 0; 
            appearance: none; -webkit-appearance: none; 
        }
        #btn-audio.active { background: var(--green) !important; border-color: var(--green) !important; color: #fff !important; box-shadow: 0 0 15px rgba(46, 204, 113, 0.5); }
        #btn-audio.inactive { background: #330000 !important; border-color: var(--red) !important; color: var(--red) !important; }

        .status-tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #333; padding-bottom: 10px; overflow-x: auto; scrollbar-width: none; }
        .tab { padding: 8px 15px; border-radius: 20px; cursor: pointer; font-weight: bold; font-size: 13px; opacity: 0.5; transition: 0.2s; border: 1px solid transparent; flex-shrink: 0; white-space: nowrap; }
        .tab.active { opacity: 1; background: var(--card-bg); border-color: var(--accent); color: var(--accent); }
        .badge { background: var(--red); color: white; padding: 2px 6px; border-radius: 50%; font-size: 10px; margin-left: 5px; vertical-align: top; }

        .orders-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; padding-bottom: 80px; }
        
        .order-card { background: var(--card-bg); border-radius: 15px; padding: 20px; border-left: 6px solid #555; animation: slideIn 0.3s ease; position: relative; }
        .order-card.status-new { border-left-color: var(--red); }
        .order-card.status-unpaid { border-left-color: var(--accent); }
        .order-card.status-pending_payment { border-left-color: #e67e22; }
        .order-card.status-processing { border-left-color: var(--blue); }
        .order-card.status-completed { border-left-color: var(--green); opacity: 1; }
        .order-card.status-rejected { border-left-color: #444; background: #222; opacity: 0.8; }

        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; border-bottom: 1px solid #444; padding-bottom: 10px; }
        .cust-name { font-size: 16px; font-weight: 700; color: #fff; text-transform: uppercase; margin-bottom: 2px; }
        .order-id { font-size: 11px; color: #666; font-family: monospace; }
        
        .header-right { text-align: right; }
        .meta-date { font-size: 13px; color: #ccc; margin-bottom: 2px; display: block; font-weight: 500; }
        
        .meta-time-block { font-size: 11px; color: #aaa; line-height: 1.4; }
        .time-highlight { color: var(--green); font-weight: 700; }
        .timer-badge { font-size: 12px; font-weight: 700; background: #000; color: var(--accent); padding: 3px 8px; border-radius: 4px; display: inline-block; margin-top: 4px; font-family: monospace; }

        .item-list { margin-bottom: 15px; max-height: 250px; overflow-y: auto; padding-right: 5px; border-bottom: 1px dashed #444; padding-bottom: 10px; }
        .item-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; align-items: flex-start; }
        .item-name { font-weight: 600; color: #eee; }
        .item-note { font-size: 11px; color: var(--accent); font-style: italic; display: block; margin-top: 2px; }
        .item-price { font-weight: 700; color: #fff; }
        .item-unit-price { font-size: 10px; color: #888; display: block; }
        .btn-trash { background: none; border: none; color: #666; cursor: pointer; font-size: 14px; padding: 0 0 0 10px; }
        .btn-trash:hover { color: var(--red); }

        .total-display { text-align: right; font-size: 18px; font-weight: 800; color: var(--accent); margin-bottom: 20px; }

        .status-footer { text-align: center; margin-top: 10px; }
        .status-text-done { color: var(--green); font-weight: 700; font-size: 16px; letter-spacing: 2px; text-transform: uppercase; }
        .stamp-rejected { border: 2px solid var(--red); color: var(--red); font-size: 20px; font-weight: 700; display: inline-block; padding: 8px 20px; transform: rotate(-5deg); letter-spacing: 1px; opacity: 0.9; margin-bottom: 10px; text-transform: uppercase; }

        .btn-print-group { display: flex; gap: 10px; margin-bottom: 15px; border-top: 1px solid #444; padding-top: 15px; }
        .btn-print { flex: 1; background: #3c3c45; border: 1px solid #555; color: #fff; padding: 12px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 700; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .btn-print:active { background: #555; transform: scale(0.98); }

        .actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; }
        .btn { border: none; padding: 12px; border-radius: 8px; font-weight: 700; cursor: pointer; transition: 0.2s; color: #fff; font-size: 14px; }
        .btn-green { background: var(--green); } .btn-red { background: var(--red); }
        .btn-blue { background: var(--blue); } .btn-grey { background: #555; }
        .btn-full { grid-column: 1 / -1; width: 100%; display: block; text-align: center; }

        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); align-items: center; justify-content: center; }
        .modal-content { background: var(--card-bg); padding: 25px; border-radius: 15px; width: 90%; max-width: 350px; border: 2px solid var(--accent); text-align: center;}
        
        @media (max-width: 768px) {
            body { flex-direction: column; height: auto; min-height: 100vh; overflow-y: auto; overflow-x: hidden; }
            .sidebar { position: fixed; bottom: 0; left: 0; width: 100%; height: 60px; flex-direction: row; justify-content: space-around; padding: 0; border-right: none; border-top: 1px solid #333; background: #1a1a1a; box-shadow: 0 -5px 15px rgba(0,0,0,0.5); z-index: 9999; }
            .brand { display: none; } 
            .menu-item { flex-direction: column; gap: 3px; font-size: 10px; padding: 5px; margin: 0; background: transparent !important; border-radius: 0; justify-content: center; flex: 1; text-align: center; color: #666; position: relative; }
            .menu-item.active { color: var(--accent); }
            .menu-icon { font-size: 20px; margin-bottom: 2px; display: block; }
            
            .nav-badge { top: 2px; right: auto; left: 50%; transform: translateX(8px); min-width: 16px; height: 16px; font-size: 9px; padding: 0; }

            .main { height: auto; overflow: visible; padding: 15px; padding-bottom: 80px; width: 100%; }
            .status-tabs { position: sticky; top: 0; background: var(--bg-dark); z-index: 50; padding-top: 10px; margin-top: -10px; }
            .orders-grid { grid-template-columns: 1fr; gap: 20px; padding-bottom: 0; } 
        }
    </style>
</head>
<body onclick="unlockAudio()">

    <div class="sidebar">
        <div class="brand">SBS KITCHEN</div>
        
        <div class="menu-item active" onclick="showPage('orders')">
            <span class="menu-icon">ðŸ“¦</span>
            <span>Pesanan</span>
            <span id="badge-nav-orders" class="nav-badge" style="display:none;">0</span>
        </div>
        
        <div class="menu-item" onclick="showPage('history')">
            <span class="menu-icon">ðŸ•’</span>
            <span>Riwayat (Hari Ini)</span>
            <span id="badge-nav-history" class="nav-badge" style="display:none;">0</span>
        </div>
    </div>

    <div class="main" id="orders-page">
        <div class="top-header">
            <h2 class="page-title">PESANAN AKTIF</h2>
            <div class="header-actions">
                <button id="btn-audio" class="inactive" onclick="toggleAudio()">ðŸ”•</button>
            </div>
        </div>

        <div class="status-tabs">
            <div class="tab" onclick="filterTab('kasir')" id="tab-kasir">KASIR <span class="badge" id="badge-kasir">0</span></div>
            <div class="tab" onclick="filterTab('dapur')" id="tab-dapur">DAPUR <span class="badge" id="badge-dapur">0</span></div>
            <div class="tab" onclick="filterTab('processing')" id="tab-processing" style="display:none;">PROSES</div> 
        </div>
        <div id="orders-grid" class="orders-grid"></div>
    </div>

    <div class="main" id="history-page" style="display: none;">
        <h2 class="page-title">RIWAYAT HARI INI</h2>
        <div id="history-grid" class="orders-grid"></div>
    </div>

    <div id="custom-confirm-modal" class="modal">
        <div class="modal-content">
            <h3 style="color:var(--accent); margin-top:0;">KONFIRMASI</h3>
            <p id="confirm-msg">Apakah Anda yakin?</p>
            <div class="actions" style="margin-top:20px;">
                <button class="btn btn-grey" onclick="closeConfirm()">BATAL</button>
                <button class="btn btn-red" id="btn-confirm-yes">YA, LANJUTKAN</button>
            </div>
        </div>
    </div>

    <audio id="sound-new" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>
    <audio id="sound-nag" src="bell.wav" preload="auto"></audio>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBSp5184dVTy-EER2qOfxeEA9KQOCMFpKo",
        authDomain: "sbs-menu-d1611.firebaseapp.com",
        databaseURL: "https://sbs-menu-d1611-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "sbs-menu-d1611",
        storageBucket: "sbs-menu-d1611.firebasestorage.app",
        messagingSenderId: "530098727952",
        appId: "1:530098727952:web:1bb3072d93be9564fbee95"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let allOrders = [];
    let currentTab = localStorage.getItem('sbs_active_tab') || 'kasir';
    let audioUnlocked = false;
    let activePage = 'orders';
    let staffName = localStorage.getItem('sbs_staff_name') || "";
    
    // --- FITUR 1: IDENTITAS KASIR ---
    window.onload = function() {
        if (!staffName) {
            staffName = prompt("Siapa nama kasir yang bertugas hari ini?") || "Kasir";
            localStorage.setItem('sbs_staff_name', staffName);
        }
    };

    const soundNew = document.getElementById('sound-new');
    const soundNag = document.getElementById('sound-nag');
    const btnAudio = document.getElementById('btn-audio');

    // --- FUNGSI AUDIO (LOGIKA LAMA) ---
    function toggleAudio() {
        if (!audioUnlocked) {
            unlockAudio();
        } else {
            audioUnlocked = false;
            btnAudio.className = 'inactive'; btnAudio.innerHTML = "ðŸ”•";
        }
    }

    function unlockAudio() {
        if (!audioUnlocked) {
            soundNew.play().then(() => {
                soundNew.pause(); soundNew.currentTime = 0;
                audioUnlocked = true;
                btnAudio.className = 'active'; btnAudio.innerHTML = "ðŸ””";
            }).catch(e => {});
        }
    }

    function fmtDur(ms) {
        if (!ms || ms < 0) return "-";
        const s = Math.floor(ms / 1000);
        const m = Math.floor(s / 60);
        return `${m}m ${s % 60}s`;
    }

    // --- LISTENER DATABASE ---
    db.ref('orders').on('value', (snapshot) => {
        const data = snapshot.val();
        const prevCount = allOrders.length;
        allOrders = [];
        
        if (data) {
            Object.keys(data).forEach(key => allOrders.push({ id: key, ...data[key] }));
        }
        
        // ALARM: Bunyi jika ada order baru atau pending payment bertambah
        if (allOrders.length > prevCount && audioUnlocked) {
            if(allOrders.some(o => o.status === 'new' || o.status === 'pending_payment')) {
                soundNew.play().catch(e => {});
            }
        }

        allOrders.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        renderOrders();
        updateBadges();
    });

    // --- FITUR 2: NOMOR ANTREAN (QUEUE) ---
    function getDailyQueueNumber(orderId) {
        const targetOrder = allOrders.find(o => o.id === orderId);
        if(!targetOrder) return "00";
        const targetDate = new Date(targetOrder.timestamp).toDateString();
        const dailyOrders = allOrders.filter(o => new Date(o.timestamp).toDateString() === targetDate)
                                   .sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));
        const index = dailyOrders.findIndex(o => o.id === orderId);
        return String(index + 1).padStart(2, '0');
    }

    // --- FITUR 3 & 4: PRINT BILL & RECEIPT (DENGAN TAX/SERVICE) ---
    function printDirect(id, type) {
        const o = allOrders.find(x => x.id === id); 
        if (!o) return;

        const queue = getDailyQueueNumber(id);
        const dateObj = new Date(o.timestamp);
        const dateStr = dateObj.toLocaleDateString('en-GB');
        const timeStr = dateObj.toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'});
        
        // Kalkulasi Pajak & Service (Contoh: 10% Pajak)
        // Pastikan total bersih dari karakter non-angka
        const subtotal = parseInt(String(o.total).replace(/[^0-9]/g, '')) || 0;
        const tax = subtotal * 0.1; 
        const totalFinal = subtotal + tax;

        const ESC = "\x1B"; const GS = "\x1D"; const INIT = ESC + "@";
        const ALIGN_CENTER = ESC + "a" + "\x01"; const ALIGN_LEFT = ESC + "a" + "\x00";
        const BOLD_ON = ESC + "E" + "\x01"; const BOLD_OFF = ESC + "E" + "\x00";
        const TEXT_DOUBLE = GS + "!" + "\x11"; const TEXT_NORMAL = GS + "!" + "\x00";

        let txt = INIT + ALIGN_CENTER;
        
        if (type === 'bill') {
            txt += BOLD_ON + "THIS IS NOT A RECEIPT\n" + BOLD_OFF;
        }

        txt += BOLD_ON + TEXT_DOUBLE + "SBS CAFE\n" + TEXT_NORMAL + BOLD_OFF +
               "Jl. Mundu 8, Kota Malang\n085159039877\n" +
               "--------------------------------\n" +
               ALIGN_LEFT + "Table : " + (o.tableNumber || "TA") + "\n" +
               "Queue : #" + queue + "\n" +
               "Date  : " + dateStr + " " + timeStr + "\n" +
               "Staff : " + staffName + "\n" +
               "--------------------------------\n";

        o.items.forEach(i => {
            const p = parseInt(i.price) || 0;
            const sub = i.qty * p;
            txt += i.name + "\n" + i.qty + "x @" + p.toLocaleString('id-ID') + "     " + sub.toLocaleString('id-ID') + "\n";
        });

        txt += "--------------------------------\n" +
               "Subtotal       " + subtotal.toLocaleString('id-ID') + "\n" +
               "Tax (10%)      " + tax.toLocaleString('id-ID') + "\n" +
               BOLD_ON + "TOTAL          " + totalFinal.toLocaleString('id-ID') + BOLD_OFF + "\n" +
               "--------------------------------\n" +
               ALIGN_CENTER + "Terima Kasih!\n\n\n\n";

        const buffer = new Uint8Array(txt.length);
        for (let i = 0; i < txt.length; i++) buffer[i] = txt.charCodeAt(i);
        window.location.href = "rawbt:base64," + btoa(String.fromCharCode(...buffer));
    }

    // --- RENDER LOGIC ---
    function renderOrders() {
        const grid = document.getElementById('orders-grid');
        const historyGrid = document.getElementById('history-grid');
        grid.innerHTML = ''; historyGrid.innerHTML = '';
        const today = new Date().toDateString();

        allOrders.forEach(order => {
            const card = createCard(order);
            const isDone = ['completed', 'rejected'].includes(order.status);
            
            if (isDone) {
                if (new Date(order.completedAt || order.timestamp).toDateString() === today) historyGrid.appendChild(card);
            } else {
                if (currentTab === 'kasir' && ['new', 'unpaid', 'qris_unpaid', 'pending_payment'].includes(order.status)) grid.appendChild(card);
                else if (currentTab === 'dapur' && order.status === 'processing') grid.appendChild(card);
            }
        });
        updateLiveTimers();
    }

    function createCard(order) {
        const div = document.createElement('div');
        div.className = `order-card status-${order.status}`;
        
        // Detail Item + Unit Price
        let itemsHtml = (order.items || []).map(i => {
            const sub = i.qty * i.price;
            const detail = i.qty > 1 ? `<span class="item-unit-price">(${i.qty}x ${i.price.toLocaleString()})</span>` : '';
            return `<div class="item-row"><div style="flex:1;"><span class="item-name">${i.qty}x ${i.name}</span>${detail}<br><small>${i.note||''}</small></div><div>${sub.toLocaleString()}</div></div>`;
        }).join('');

        // FITUR 5: TOMBOL LAYOUT BARU
        let actionButtons = '';
        // Cek status untuk menampilkan tombol yang sesuai
        if (['new', 'unpaid', 'qris_unpaid'].includes(order.status)) {
             // Layout: Tolak | Print Bill (Baris 1), Terima (Baris 2 - Full)
             // Jika QRIS unpaid, tombol terima disabled/hidden atau berbeda logic
             let btnTerima = `<button class="btn btn-blue btn-full" style="grid-column: 1 / -1;" onclick="updateStatus('${order.id}', 'processing')">TERIMA & PROSES</button>`;
             
             if (order.status === 'qris_unpaid') {
                 // Kunci tombol terima jika QRIS belum bayar
                 btnTerima = `<button class="btn btn-disabled btn-full" style="grid-column: 1 / -1; opacity: 0.6; cursor: not-allowed;">MENUNGGU PEMBAYARAN</button>`;
             }

             actionButtons = `
                <div class="actions" style="grid-template-columns: 1fr 1fr; display: grid; gap: 10px;">
                    <button class="btn btn-red" onclick="confirmReject('${order.id}')">TOLAK</button>
                    <button class="btn btn-grey" onclick="printDirect('${order.id}', 'bill')">PRINT BILL</button>
                    ${btnTerima}
                </div>`;
        } else if (order.status === 'pending_payment') {
             // QRIS sudah bayar (menunggu verifikasi)
             actionButtons = `
                <div class="actions" style="grid-template-columns: 1fr 1fr; display: grid; gap: 10px;">
                    <button class="btn btn-red" onclick="confirmReject('${order.id}')">TOLAK</button>
                    <button class="btn btn-grey" onclick="printDirect('${order.id}', 'bill')">PRINT BILL</button>
                    <button class="btn btn-blue btn-full" style="grid-column: 1 / -1;" onclick="updateStatus('${order.id}', 'processing')">VERIFIKASI & PROSES</button>
                </div>`;
        } else if (order.status === 'processing') {
             actionButtons = `<div class="actions"><button class="btn btn-green btn-full" onclick="updateStatus('${order.id}', 'completed')">SELESAI & ANTAR</button></div>`;
        }

        // --- LOGIKA TAMPILAN JAM MASUK (REVISI PERMINTAAN) ---
        const timeIn = new Date(order.timestamp).toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'});
        let timeDisplayHtml = `<span class="time-val">${timeIn}</span>`;

        if (order.status === 'qris_unpaid') {
            // Tampilkan teks Menunggu Pembayaran warna oranye/kuning
            timeDisplayHtml = `<span style="color: #FFD200; font-weight: bold; font-size: 11px; text-transform: uppercase;">Menunggu Pembayaran</span>`;
        }

        div.innerHTML = `
            <div class="card-header">
                <div><b>MEJA ${order.tableNumber || 'TA'}</b><br><small>ID: ...${order.id.slice(-4)}</small></div>
                <div class="header-right">
                    <div class="meta-time-block">
                        <span class="time-label">Masuk:</span> 
                        ${timeDisplayHtml}
                    </div>
                    <div class="timer-badge live-timer" data-start="${new Date(order.timestamp).getTime()}">--:--</div>
                </div>
            </div>
            <div class="item-list">${itemsHtml}</div>
            <div class="total-display">Total: Rp ${parseInt(order.total).toLocaleString()}</div>
            ${actionButtons}
        `;
        return div;
    }

    function updateStatus(key, status) {
        const updates = { status: status };
        const now = new Date().toISOString();
        if(status === 'processing') { updates.paidAt = now; printDirect(key, 'checker'); }
        if(status === 'completed') updates.completedAt = now;
        db.ref('orders/' + key).update(updates);
    }
    
    function confirmReject(key) {
        // Tampilkan modal konfirmasi custom
        document.getElementById('confirm-msg').innerText = "Yakin tolak pesanan ini?";
        confirmCallback = () => {
             const updates = { status: 'rejected', completedAt: new Date().toISOString() };
             db.ref('orders/' + key).update(updates);
        };
        document.getElementById('custom-confirm-modal').style.display = 'flex';
    }
    
    let confirmCallback = null;
    function closeConfirm() { document.getElementById('custom-confirm-modal').style.display = 'none'; }
    document.getElementById('btn-confirm-yes').onclick = () => { if(confirmCallback) confirmCallback(); closeConfirm(); };

    function filterTab(t) { currentTab = t; localStorage.setItem('sbs_active_tab', t); renderOrders(); updateBadges(); }
    
    function updateBadges() {
        document.getElementById('badge-kasir').innerText = allOrders.filter(o => ['new', 'unpaid', 'qris_unpaid', 'pending_payment'].includes(o.status)).length;
        document.getElementById('badge-dapur').innerText = allOrders.filter(o => o.status === 'processing').length;
    }
    
    function updateLiveTimers() {
        document.querySelectorAll('.live-timer').forEach(el => {
            const start = parseInt(el.dataset.start);
            const diff = Date.now() - start;
            el.innerText = `â± ${Math.floor(diff/60000)}:${String(Math.floor((diff%60000)/1000)).padStart(2,'0')}`;
        });
        checkNaggingAlarm();
    }
    
    function checkNaggingAlarm() {
        if (!audioUnlocked) return;
        const now = Date.now();
        // Alarm bunyi jika ada order baru/pending payment yang belum direspon > 2 menit
        if (allOrders.some(order => {
            if (['new', 'pending_payment'].includes(order.status)) {
                const diff = (now - new Date(order.timestamp).getTime()) / 1000;
                return diff > 120 && (diff % 120) < 1.5;
            }
            return false;
        })) {
            soundNag.currentTime = 0;
            soundNag.play().catch(e => {});
        }
    }
    
    setInterval(updateLiveTimers, 1000);
    
    function showPage(pageId) {
        document.querySelectorAll('.main').forEach(el => el.style.display = 'none');
        document.getElementById(pageId + '-page').style.display = 'block';
        document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
        if(pageId === 'orders') document.querySelectorAll('.menu-item')[0].classList.add('active');
        if(pageId === 'history') document.querySelectorAll('.menu-item')[1].classList.add('active');
    }
</script>
</body>
</html>
