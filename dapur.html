    <script>
        // --- KONFIGURASI FIREBASE (SAMA) ---
        const firebaseConfig = {
            apiKey: "AIzaSyBSp5184dVTy-EER2qOfxeEA9KQOCMFpKo",
            authDomain: "sbs-menu-d1611.firebaseapp.com",
            databaseURL: "https://sbs-menu-d1611-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "sbs-menu-d1611",
            storageBucket: "sbs-menu-d1611.firebasestorage.app",
            messagingSenderId: "530098727952",
            appId: "1:530098727952:web:1bb3072d93be9564fbee95"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.database();
        
        // --- VARIABEL GLOBAL ---
        let allOrders = [];
        let currentTab = localStorage.getItem('sbs_active_tab') || 'new';
        let editingOrderKey = null;
        let audioUnlocked = false;
        let confirmCallback = null;
        const soundNew = document.getElementById('sound-new');
        const soundNag = document.getElementById('sound-nag');
        const btnAudio = document.getElementById('btn-audio');

        // --- INIT TAB ---
        function initActiveTab() {
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            const activeEl = document.getElementById('tab-' + currentTab);
            if(activeEl) activeEl.classList.add('active');
        }
        initActiveTab();

        // --- AUDIO LOGIC ---
        function toggleAudio() {
            if (!audioUnlocked) {
                soundNew.play().then(() => {
                    soundNew.pause(); soundNew.currentTime = 0;
                    audioUnlocked = true;
                    btnAudio.className = 'active'; btnAudio.innerHTML = "üîî";
                }).catch(e => console.log(e));
            } else {
                audioUnlocked = false;
                btnAudio.className = 'inactive'; btnAudio.innerHTML = "üîï";
            }
        }

        function unlockAudio() {
            if (!audioUnlocked) {
                soundNew.play().then(() => {
                    soundNew.pause(); soundNew.currentTime = 0;
                    audioUnlocked = true;
                    btnAudio.className = 'active'; btnAudio.innerHTML = "üîî";
                }).catch(e => {});
            }
        }

        // --- LOAD DATA DARI FIREBASE ---
        db.ref('orders').on('value', (snapshot) => {
            const data = snapshot.val();
            const prevCount = allOrders.length; 
            
            allOrders = [];
            if (data) Object.keys(data).forEach(key => allOrders.push({ id: key, ...data[key] }));
            
            // Alarm Bunyi jika ada pesanan status 'new' atau 'pending_payment' baru masuk
            if (allOrders.length > prevCount && audioUnlocked) {
                if(allOrders.some(o => o.status === 'new' || o.status === 'pending_payment')) {
                    soundNew.play().catch(e => {});
                }
            }
            
            allOrders.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            renderOrders();
            updateBadges();
        });

        // --- FUNGSI PRINT (TETAP SAMA) ---
        function getDailyQueueNumber(orderId) {
            const targetOrder = allOrders.find(o => o.id === orderId);
            if(!targetOrder) return "00";
            const targetDate = new Date(targetOrder.timestamp).toDateString();
            const dailyOrders = allOrders.filter(o => new Date(o.timestamp).toDateString() === targetDate).sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));
            const index = dailyOrders.findIndex(o => o.id === orderId);
            return index + 1;
        }

        function printDirect(orderId, type) {
            // (Kode Print Lama Anda Disini - Tidak Diubah Agar Printer Tetap Jalan)
            // ... Saya singkat biar tidak kepanjangan, isinya sama persis dengan file dapur(5)
            const order = allOrders.find(o => o.id === orderId);
            if (!order) return;
            // ... logika print ...
            let tableNum = order.tableNumber || "Take Away";
            // ... (Kode RawBT Anda tetap aman) ...
            // Jika mau saya tulis ulang full print functionnya kabari ya, tapi asumsi saya Anda copy paste bagian ini dari file lama.
             const dateObj = new Date(order.timestamp);
             // ... Logika Base64 ...
        }
        // *CATATAN PENTING*: Pastikan fungsi printDirect dari file lama tetap ada di sini.

        // --- TIMER & ALARM ---
        setInterval(() => {
            updateLiveTimers();
            checkNaggingAlarm();
        }, 1000);

        function checkNaggingAlarm() {
            if (!audioUnlocked) return;
            const now = Date.now();
            if (allOrders.some(order => {
                // Alarm bunyi terus kalau ada 'new' atau 'pending_payment' yg didiamkan > 2 menit
                if (order.status !== 'new' && order.status !== 'pending_payment') return false;
                const diff = (now - new Date(order.timestamp).getTime()) / 1000;
                return diff > 120 && (diff % 120) < 1.5;
            })) {
                soundNag.currentTime = 0;
                soundNag.play().catch(e => {});
            }
        }

        function updateLiveTimers() {
            document.querySelectorAll('.live-timer').forEach(el => {
                const startTime = parseInt(el.getAttribute('data-start'));
                if (!startTime || isNaN(startTime)) { el.innerText = "--:--"; return; }
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                if (elapsed > 86400) { el.innerText = "> 24h"; return; }
                const min = Math.floor(elapsed / 60);
                const sec = elapsed % 60;
                el.innerText = `‚è± ${min}:${sec < 10 ? '0'+sec : sec}`;
            });
        }

        // --- RENDER UTAMA (LOGIKA BARU DISINI) ---
        function renderOrders() {
            const grid = document.getElementById('orders-grid');
            const historyGrid = document.getElementById('history-grid');
            grid.innerHTML = '';
            historyGrid.innerHTML = '';
            const today = new Date().toDateString();

            allOrders.forEach(order => {
                const card = createCard(order);
                const orderDate = new Date(order.completedAt || order.timestamp).toDateString();
                
                // History Logic
                if (['completed', 'rejected', 'done'].includes(order.status)) {
                    if (orderDate === today) historyGrid.appendChild(card);
                } else {
                    // --- REVISI LOGIKA TAB ---
                    // 1. Tab BARU: Hanya menampilkan status 'new' (Tunai yg belum diverifikasi)
                    if (currentTab === 'new' && order.status === 'new') {
                        grid.appendChild(card);
                    }
                    // 2. Tab BAYAR: Menampilkan 'unpaid' (sudah diterima) DAN 'pending_payment' (QRIS masuk)
                    else if (currentTab === 'unpaid') {
                        if (order.status === 'unpaid' || order.status === 'pending_payment') {
                            grid.appendChild(card);
                        }
                    }
                    // 3. Tab PROSES
                    else if (currentTab === 'processing' && order.status === 'processing') {
                        grid.appendChild(card);
                    }
                }
            });
            updateLiveTimers();
        }

        function createCard(order) {
            let displayName = "Pelanggan";
            if (order.tableNumber) {
                displayName = "MEJA " + order.tableNumber;
                if (order.customerName) displayName += " - " + order.customerName.toUpperCase();
            }

            const created = new Date(order.timestamp).getTime();
            
            // Tentukan Timer Start berdasarkan status
            let timerStart = created;
            if (order.status === 'processing' && order.paidAt) timerStart = new Date(order.paidAt).getTime();

            const div = document.createElement('div');
            // Tambahkan class status agar warna border sesuai (status-pending_payment kita anggap mirip unpaid/oranye)
            div.className = `order-card status-${order.status}`;
            if(order.status === 'pending_payment') div.style.borderLeftColor = '#e67e22'; // Paksa warna oranye untuk QRIS
            
            let itemsHtml = (order.items || []).map((item, idx) => {
                const qty = parseInt(item.qty);
                const price = parseInt(item.price);
                const subtotal = qty * price;
                const trashBtn = (order.status !== 'completed' && order.status !== 'rejected') ? `<button class="btn-trash" onclick="deleteOrderItem('${order.id}', ${idx})">üóë</button>` : '';
                return `
                <div class="item-row">
                    <div style="flex:1;">
                        <span class="item-name">${qty}x ${item.name}</span>
                        ${item.note ? `<span class="item-note">üìù ${item.note}</span>` : ''}
                    </div>
                    <div style="text-align:right;">
                        <span class="item-price">${subtotal.toLocaleString()}</span>
                        ${trashBtn}
                    </div>
                </div>`;
            }).join('');

            const timeIn = new Date(created).toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'});
            
            // Badge Metode Bayar
            let paymentBadge = '';
            if(order.paymentMethod === 'qris') paymentBadge = '<span style="background:#000; color:#fff; padding:2px 6px; border-radius:4px; font-size:10px;">QRIS</span>';
            else paymentBadge = '<span style="background:#ddd; color:#000; padding:2px 6px; border-radius:4px; font-size:10px;">TUNAI</span>';

            // TOMBOL AKSI (REVISI DISINI)
            let buttonsHtml = '';
            
            // 1. Pesanan Tunai Baru
            if (order.status === 'new') {
                buttonsHtml = `
                    <button class="btn btn-red" onclick="confirmReject('${order.id}')">Tolak</button>
                    <button class="btn btn-grey" onclick="openEditModal('${order.id}')">+ Item</button>
                    <button class="btn btn-green btn-full" onclick="updateStatus('${order.id}', 'unpaid')">Terima (Tunggu Bayar)</button>`;
            } 
            // 2. Pesanan QRIS (Menunggu Verifikasi)
            else if (order.status === 'pending_payment') {
                buttonsHtml = `
                    <div style="grid-column:span 2; text-align:center; color:#e67e22; font-weight:bold; font-size:12px; margin-bottom:5px;">
                        ‚ö† CEK BUKTI TRANSFER DULU
                    </div>
                    <button class="btn btn-red" onclick="confirmReject('${order.id}')">Tolak</button>
                    <button class="btn btn-blue" onclick="updateStatus('${order.id}', 'processing')">VERIFIKASI & PROSES</button>`;
            }
            // 3. Pesanan Tunai (Sudah Diterima, Belum Bayar)
            else if (order.status === 'unpaid') {
                buttonsHtml = `
                    <button class="btn btn-grey" onclick="updateStatus('${order.id}', 'new')">Kembali</button>
                    <button class="btn btn-blue" onclick="updateStatus('${order.id}', 'processing')">LUNAS & PROSES</button>`;
            } 
            // 4. Sedang Diproses
            else if (order.status === 'processing') {
                buttonsHtml = `<button class="btn btn-green btn-full" onclick="updateStatus('${order.id}', 'completed')">Selesai & Antar</button>`;
            }

            // Print buttons logic
            let printButtons = '';
            if(order.status !== 'rejected') {
                // ... (Logic tombol print sama seperti file lama)
                printButtons = `<div class="btn-print-group"><button class="btn-print" onclick="printDirect('${order.id}', 'checker')">üñ® CHECKER</button></div>`; 
            }

            div.innerHTML = `
                <div class="card-header">
                    <div class="header-left">
                        <span class="cust-name">${displayName}</span>
                        <div style="margin-top:2px;">${paymentBadge} <span class="order-id">ID: ...${order.id.slice(-4)}</span></div>
                    </div>
                    <div class="header-right">
                        <div class="meta-time-block"><span class="time-val">${timeIn}</span></div>
                        <div class="timer-badge live-timer" data-start="${timerStart}">--:--</div>
                    </div>
                </div>
                <div class="item-list">${itemsHtml}</div>
                <div class="total-display">Total: Rp ${parseInt(order.total).toLocaleString()}</div>
                ${printButtons}
                <div class="actions">${buttonsHtml}</div>
            `;
            return div;
        }

        function updateStatus(key, status) {
            const updates = { status: status };
            const now = new Date().toISOString(); 
            if(status === 'unpaid') updates.acceptedAt = now; 
            if(status === 'processing') updates.paidAt = now; 
            if(status === 'completed' || status === 'rejected') updates.completedAt = now; 
            db.ref('orders/' + key).update(updates);
        }

        function confirmReject(key) { showConfirm("Yakin tolak pesanan ini?", () => updateStatus(key, 'rejected')); }
        
        // --- BADGES UPDATE (REVISI) ---
        function updateBadges() {
            document.getElementById('badge-new').innerText = allOrders.filter(o => o.status === 'new').length;
            // Tab Bayar menghitung Unpaid DAN Pending Payment
            document.getElementById('badge-unpaid').innerText = allOrders.filter(o => o.status === 'unpaid' || o.status === 'pending_payment').length;
            document.getElementById('badge-processing').innerText = allOrders.filter(o => o.status === 'processing').length;
        }

        // --- FUNGSI PENDUKUNG LAINNYA (SAMA) ---
        function deleteOrderItem(orderKey, itemIndex) {
            // ... (logika delete item lama) ...
             showConfirm("Hapus item ini?", () => {
                const order = allOrders.find(o => o.id === orderKey);
                const newItems = [...order.items];
                const removed = newItems.splice(itemIndex, 1)[0];
                let currentTotal = parseInt(String(order.total).replace(/[^0-9]/g, '')) || 0;
                db.ref('orders/' + orderKey).update({ items: newItems, total: currentTotal - (removed.price * removed.qty) });
            });
        }
        function showPage(pageId) {
            document.querySelectorAll('.main').forEach(el => el.style.display = 'none');
            document.getElementById(pageId + '-page').style.display = 'block';
            document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
            if(pageId === 'orders') document.querySelectorAll('.menu-item')[0].classList.add('active');
            if(pageId === 'history') document.querySelectorAll('.menu-item')[1].classList.add('active');
        }
        function filterTab(status) {
            currentTab = status;
            localStorage.setItem('sbs_active_tab', status);
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');
            renderOrders();
        }
        function showConfirm(m, c) { document.getElementById('confirm-msg').innerText = m; confirmCallback = c; document.getElementById('custom-confirm-modal').style.display = 'flex'; }
        function closeConfirm() { document.getElementById('custom-confirm-modal').style.display = 'none'; }
        document.getElementById('btn-confirm-yes').onclick = () => { confirmCallback(); closeConfirm(); };
        function openEditModal(k) { editingOrderKey = k; document.getElementById('edit-modal').style.display = 'flex'; }
        function closeModal() { document.getElementById('edit-modal').style.display = 'none'; }
        function saveExtraItem() {
            const n = document.getElementById('extra-name').value;
            const p = parseInt(document.getElementById('extra-price').value);
            if(!n || !p) return;
            const o = allOrders.find(x => x.id === editingOrderKey);
            const items = [...(o.items||[]), { name: n, price: p, qty: 1, note: 'Manual' }];
            const tot = (Number(String(o.total).replace(/[^0-9]/g, '')) || 0) + p;
            db.ref('orders/' + editingOrderKey).update({ items: items, total: tot }).then(() => closeModal());
        }
    </script>
