<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SBS Kitchen - OPS</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Poppins:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --bg-dark: #1e1e24; --card-bg: #2b2b36; --accent: #FFD200; --text: #eaeaea; --green: #2ecc71; --red: #e74c3c; --blue: #3498db; }
        * { box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background: var(--bg-dark); color: var(--text); margin: 0; padding: 0; display: flex; height: 100vh; overflow: hidden; }
        
        .sidebar { width: 260px; background: #15151a; padding: 20px; display: flex; flex-direction: column; border-right: 1px solid #333; flex-shrink: 0; z-index: 100; }
        .brand { font-family: 'Bebas Neue'; font-size: 40px; color: var(--accent); margin-bottom: 40px; text-align: center; letter-spacing: 2px; }
        
        .menu-item { 
            padding: 15px; cursor: pointer; border-radius: 10px; margin-bottom: 10px; 
            font-weight: 600; transition: 0.2s; color: #888; display: flex; 
            align-items: center; gap: 10px; position: relative; 
        }
        .menu-item.active, .menu-item:hover { background: var(--card-bg); color: var(--accent); }
        .menu-icon { font-size: 20px; }

        /* --- ANIMASI KARTU HILANG --- */
        .fade-out {
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0;
            transform: scale(0.8);
            max-height: 0 !important;
            margin-bottom: 0 !important;
            padding-top: 0 !important;
            padding-bottom: 0 !important;
            border: none !important;
            overflow: hidden;
        }
        
        /* BADGE NOTIFIKASI */
        .nav-badge {
            position: absolute; top: 5px; right: 15px;
            background-color: var(--red); color: #fff;
            font-size: 10px; font-weight: 900;
            padding: 0; border-radius: 50%;
            width: 18px; height: 18px;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5); z-index: 10;
            border: 2px solid #fff;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }

        .main { flex: 1; padding: 20px; overflow-y: auto; position: relative; scroll-behavior: smooth; }
        .top-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .page-title { margin:0; font-family:'Bebas Neue'; color:var(--accent); font-size: 28px; }
        .header-actions { display: flex; gap: 15px; align-items: center; }
        
        /* TOMBOL AUDIO */
        #btn-audio { 
            background: #330000; border: 2px solid var(--red); border-radius: 50%; width: 44px; height: 44px; 
            cursor: pointer; font-size: 22px; display: flex; align-items: center; justify-content: center; 
            color: var(--red); transition: all 0.3s ease; outline: none; padding: 0; 
            appearance: none; -webkit-appearance: none; 
        }
        #btn-audio.active { background: var(--green) !important; border-color: var(--green) !important; color: #fff !important; box-shadow: 0 0 15px rgba(46, 204, 113, 0.5); }
        #btn-audio.inactive { background: #330000 !important; border-color: var(--red) !important; color: var(--red) !important; }

        .status-tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #333; padding-bottom: 10px; overflow-x: auto; scrollbar-width: none; }
        .tab { padding: 8px 15px; border-radius: 20px; cursor: pointer; font-weight: bold; font-size: 13px; opacity: 0.5; transition: 0.2s; border: 1px solid transparent; flex-shrink: 0; white-space: nowrap; }
        .tab.active { opacity: 1; background: var(--card-bg); border-color: var(--accent); color: var(--accent); }
        .badge { background: var(--red); color: white; padding: 2px 6px; border-radius: 50%; font-size: 10px; margin-left: 5px; vertical-align: top; }

        .orders-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; padding-bottom: 80px; }
        
        .order-card { background: var(--card-bg); border-radius: 15px; padding: 20px; border-left: 6px solid #555; animation: slideIn 0.3s ease; position: relative; }
        .order-card.status-new { border-left-color: var(--red); }
        .order-card.status-unpaid { border-left-color: var(--accent); }
        .order-card.status-pending_payment { border-left-color: #e67e22; }
        .order-card.status-processing { border-left-color: var(--blue); }
        .order-card.status-completed { border-left-color: var(--green); opacity: 1; }
        .order-card.status-rejected { border-left-color: #444; background: #222; opacity: 0.8; }

        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; border-bottom: 1px solid #444; padding-bottom: 10px; }
        .cust-name { font-size: 16px; font-weight: 700; color: #fff; text-transform: uppercase; margin-bottom: 2px; }
        .order-id { font-size: 11px; color: #666; font-family: monospace; }
        
        .header-right { text-align: right; }
        .meta-date { font-size: 13px; color: #ccc; margin-bottom: 2px; display: block; font-weight: 500; }
        
        .meta-time-block { font-size: 11px; color: #aaa; line-height: 1.4; }
        .time-highlight { color: var(--green); font-weight: 700; }
        .timer-badge { font-size: 12px; font-weight: 700; background: #000; color: var(--accent); padding: 3px 8px; border-radius: 4px; display: inline-block; margin-top: 4px; font-family: monospace; }

        .item-list { margin-bottom: 15px; max-height: 250px; overflow-y: auto; padding-right: 5px; border-bottom: 1px dashed #444; padding-bottom: 10px; }
        .item-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; align-items: flex-start; }
        .item-name { font-weight: 600; color: #eee; }
        .item-note { font-size: 11px; color: var(--accent); font-style: italic; display: block; margin-top: 2px; }
        .item-price { font-weight: 700; color: #fff; }
        .item-unit-price { font-size: 10px; color: #888; display: block; }
        .btn-trash { background: none; border: none; color: #666; cursor: pointer; font-size: 14px; padding: 0 0 0 10px; }
        .btn-trash:hover { color: var(--red); }

        .total-display { text-align: right; font-size: 18px; font-weight: 800; color: var(--accent); margin-bottom: 20px; }

        .status-footer { text-align: center; margin-top: 10px; }
        .status-text-done { color: var(--green); font-weight: 700; font-size: 16px; letter-spacing: 2px; text-transform: uppercase; }
        .stamp-rejected { border: 2px solid var(--red); color: var(--red); font-size: 20px; font-weight: 700; display: inline-block; padding: 8px 20px; transform: rotate(-5deg); letter-spacing: 1px; opacity: 0.9; margin-bottom: 10px; text-transform: uppercase; }

        .btn-print-group { display: flex; gap: 10px; margin-bottom: 15px; border-top: 1px solid #444; padding-top: 15px; }
        .btn-print { flex: 1; background: #3c3c45; border: 1px solid #555; color: #fff; padding: 12px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 700; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .btn-print:active { background: #555; transform: scale(0.98); }

        .actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; }
        .btn { border: none; padding: 12px; border-radius: 8px; font-weight: 700; cursor: pointer; transition: 0.2s; color: #fff; font-size: 14px; }
        .btn-green { background: var(--green); } .btn-red { background: var(--red); }
        .btn-blue { background: var(--blue); } .btn-grey { background: #555; }
        .btn-full { grid-column: 1 / -1; width: 100%; display: block; text-align: center; }

        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); align-items: center; justify-content: center; }
        .modal-content { background: var(--card-bg); padding: 25px; border-radius: 15px; width: 90%; max-width: 350px; border: 2px solid var(--accent); text-align: center;}
        
        @media (max-width: 768px) {
            body { flex-direction: column; height: auto; min-height: 100vh; overflow-y: auto; overflow-x: hidden; }
            .sidebar { position: fixed; bottom: 0; left: 0; width: 100%; height: 60px; flex-direction: row; justify-content: space-around; padding: 0; border-right: none; border-top: 1px solid #333; background: #1a1a1a; box-shadow: 0 -5px 15px rgba(0,0,0,0.5); z-index: 9999; }
            .brand { display: none; } 
            .menu-item { flex-direction: column; gap: 3px; font-size: 10px; padding: 5px; margin: 0; background: transparent !important; border-radius: 0; justify-content: center; flex: 1; text-align: center; color: #666; position: relative; }
            .menu-item.active { color: var(--accent); }
            .menu-icon { font-size: 20px; margin-bottom: 2px; display: block; }
            
            .nav-badge { top: 2px; right: auto; left: 50%; transform: translateX(8px); min-width: 16px; height: 16px; font-size: 9px; padding: 0; }

            .main { height: auto; overflow: visible; padding: 15px; padding-bottom: 80px; width: 100%; }
            .status-tabs { position: sticky; top: 0; background: var(--bg-dark); z-index: 50; padding-top: 10px; margin-top: -10px; }
            .orders-grid { grid-template-columns: 1fr; gap: 20px; padding-bottom: 0; } 
        }
    </style>
</head>
<body onclick="unlockAudio()">

    <div class="sidebar">
        <div class="brand">SBS KITCHEN</div>
        
        <div class="menu-item active" onclick="showPage('orders')">
            <span class="menu-icon">üì¶</span>
            <span>Pesanan</span>
            <span id="badge-nav-orders" class="nav-badge" style="display:none;">0</span>
        </div>
        
        <div class="menu-item" onclick="showPage('history')">
            <span class="menu-icon">üïí</span>
            <span>Riwayat (Hari Ini)</span>
            <span id="badge-nav-history" class="nav-badge" style="display:none;">0</span>
        </div>
    </div>

    <div class="main" id="orders-page">
        <div class="top-header">
            <h2 class="page-title">PESANAN AKTIF</h2>
            <div class="header-actions">
                <button id="btn-audio" class="inactive" onclick="toggleAudio()">üîï</button>
            </div>
        </div>

        <div class="status-tabs">
            <div class="tab" onclick="filterTab('kasir')" id="tab-kasir">KASIR <span class="badge" id="badge-kasir">0</span></div>
            <div class="tab" onclick="filterTab('dapur')" id="tab-dapur">DAPUR <span class="badge" id="badge-dapur">0</span></div>
            <div class="tab" onclick="filterTab('processing')" id="tab-processing" style="display:none;">PROSES</div> 
        </div>
        <div id="orders-grid" class="orders-grid"></div>
    </div>

    <div class="main" id="history-page" style="display: none;">
        <h2 class="page-title">RIWAYAT HARI INI</h2>
        <div id="history-grid" class="orders-grid"></div>
    </div>

    <div id="custom-confirm-modal" class="modal">
        <div class="modal-content">
            <h3 style="color:var(--accent); margin-top:0;">KONFIRMASI</h3>
            <p id="confirm-msg">Apakah Anda yakin?</p>
            <div class="actions" style="margin-top:20px;">
                <button class="btn btn-grey" onclick="closeConfirm()">BATAL</button>
                <button class="btn btn-red" id="btn-confirm-yes">YA, LANJUTKAN</button>
            </div>
        </div>
    </div>

    <audio id="sound-new" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>
    <audio id="sound-nag" src="bell.wav" preload="auto"></audio>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

<script>
    // --- KONFIGURASI FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyBSp5184dVTy-EER2qOfxeEA9KQOCMFpKo",
        authDomain: "sbs-menu-d1611.firebaseapp.com",
        databaseURL: "https://sbs-menu-d1611-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "sbs-menu-d1611",
        storageBucket: "sbs-menu-d1611.firebasestorage.app",
        messagingSenderId: "530098727952",
        appId: "1:530098727952:web:1bb3072d93be9564fbee95"
    };

    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.database();
    
    // --- STATE MANAGEMENT ---
    let currentTab = localStorage.getItem('sbs_active_tab') || 'kasir';
    let allOrders = [];
    let activePage = 'orders'; 
    let audioUnlocked = false;
    let hasInteracted = false;
    let isFirstLoad = true;
    
    let unreadOrdersCount = 0;
    let unreadHistoryCount = 0;
    let realActiveCount = 0;
    let realHistoryCount = 0;
    
    // Data Kasir (Default)
    let cashierList = ['Kasir 1', 'Kasir 2', 'Kasir 3'];

    // GLOBAL TAX SETTING
    let isTaxEnabled = false;
    db.ref('settings/tax_enabled').on('value', snap => {
        isTaxEnabled = snap.val() || false;
        renderOrders();
    });

    // LOAD EMPLOYEES
    db.ref('employees').on('value', snap => {
        const fetched = [];
        if(snap.val()){
            Object.keys(snap.val()).forEach(k => {
                const emp = snap.val()[k];
                if(emp.role && emp.role.toLowerCase() === 'kasir') {
                    fetched.push(emp.name);
                }
            });
        }
        if(fetched.length > 0) cashierList = fetched;
        renderOrders(); 
    });

    const soundNew = document.getElementById('sound-new');
    const soundNag = document.getElementById('sound-nag');
    const btnAudio = document.getElementById('btn-audio');

    function fmtDur(ms) {
        if (!ms || ms < 0) return "-";
        const s = Math.floor(ms / 1000);
        const m = Math.floor(s / 60);
        const rs = s % 60;
        return `${m}m ${rs}s`;
    }
    // --- LOGIKA AUDIO BARU (SAKLAR & KUNCI) ---

    // 1. Fungsi Body (Hanya jalan 1x di awal)
    function unlockAudio() {
        // Cek: Apakah ini interaksi pertama?
        if (!hasInteracted) {
            soundNew.play().then(() => {
                soundNew.pause(); soundNew.currentTime = 0;
                
                // Nyalakan Audio & Kunci Interaksi Selanjutnya
                audioUnlocked = true;
                hasInteracted = true; 
                
                updateAudioBtnUI();
            }).catch(e => {
                console.log("Audio belum diizinkan browser");
            });
        }
    }

    // 2. Fungsi Tombol (Saklar Manual ON/OFF)
    function toggleAudio(e) {
        if(e) e.stopPropagation(); // Wajib: Agar tidak dianggap klik body

        // Tandai sudah interaksi (agar klik body tidak lagi berpengaruh)
        hasInteracted = true; 

        audioUnlocked = !audioUnlocked; // Balik Status

        if (audioUnlocked) {
            // -- NYALA --
            soundNew.play().then(() => {
                soundNew.pause(); soundNew.currentTime = 0;
            }).catch(()=>{});
        } else {
            // -- MATI --
            // Matikan paksa semua suara
            if(soundNew) { soundNew.pause(); soundNew.currentTime = 0; }
            if(soundNag) { soundNag.pause(); soundNag.currentTime = 0; }
        }
        updateAudioBtnUI();
    }

    // 3. Update Tampilan Icon
    function updateAudioBtnUI() {
        if(!btnAudio) return;
        if (audioUnlocked) {
            btnAudio.innerHTML = "üîî";
            btnAudio.classList.remove('inactive');
            btnAudio.classList.add('active');
        } else {
            btnAudio.innerHTML = "üîï";
            btnAudio.classList.remove('active');
            btnAudio.classList.add('inactive');
        }
    }

    // --- LISTENER FIREBASE ---
    let previousOrderStatuses = {};
    
    db.ref('orders').on('value', (snapshot) => {
        const data = snapshot.val();
        let shouldRing = false;
        const currentStatuses = {};

        allOrders = [];
        if (data) {
            Object.keys(data).forEach(key => {
                const order = { id: key, ...data[key] };
                allOrders.push(order);
                currentStatuses[key] = order.status;

                if (!isFirstLoad && audioUnlocked) {
                    const currentStat = order.status;
                    const prevStat = previousOrderStatuses[key];
                    if (currentStat === 'new' && prevStat !== 'new') shouldRing = true;
                    if (currentStat === 'pending_payment' && prevStat === 'qris_unpaid') shouldRing = true;
                }
            });
        }
        
        realActiveCount = allOrders.filter(o => ['new', 'qris_unpaid', 'pending_payment', 'unpaid'].includes(o.status)).length;
        const todayStr = new Date().toDateString();
        realHistoryCount = allOrders.filter(o => 
            (['completed', 'rejected'].includes(o.status)) && 
            (new Date(o.completedAt || o.timestamp).toDateString() === todayStr)
        ).length;

        let seenOrd = parseInt(localStorage.getItem('sbs_seen_orders')) || 0;
        let seenHis = parseInt(localStorage.getItem('sbs_seen_history')) || 0;

        if (realActiveCount < seenOrd) { seenOrd = realActiveCount; localStorage.setItem('sbs_seen_orders', seenOrd); }
        if (realHistoryCount < seenHis) { seenHis = realHistoryCount; localStorage.setItem('sbs_seen_history', seenHis); }

        unreadOrdersCount = realActiveCount - seenOrd;
        unreadHistoryCount = realHistoryCount - seenHis;

        if (activePage === 'orders') { unreadOrdersCount = 0; localStorage.setItem('sbs_seen_orders', realActiveCount); }
        if (activePage === 'history') { unreadHistoryCount = 0; localStorage.setItem('sbs_seen_history', realHistoryCount); }

        previousOrderStatuses = currentStatuses;
        if (isFirstLoad) isFirstLoad = false;
        
        if (shouldRing) soundNew.play().catch(e => {});
        
        allOrders.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        
        updateNavBadges();
        setupTabs(); 
        renderOrders();
        updateTabBadges();
    });

    function updateNavBadges() {
        const badgeOrd = document.getElementById('badge-nav-orders');
        const badgeHis = document.getElementById('badge-nav-history');
        badgeOrd.innerText = unreadOrdersCount;
        badgeOrd.style.display = (unreadOrdersCount > 0) ? 'flex' : 'none';
        badgeHis.innerText = unreadHistoryCount;
        badgeHis.style.display = (unreadHistoryCount > 0) ? 'flex' : 'none';
    }

    function updateTabBadges() {
        const countKasir = realActiveCount;
        const countDapur = allOrders.filter(o => o.status === 'processing').length;
        const badgeK = document.getElementById('badge-kasir');
        const badgeD = document.getElementById('badge-dapur');
        badgeK.innerText = countKasir;
        badgeD.innerText = countDapur;
        badgeK.style.backgroundColor = (countKasir > 0) ? 'var(--red)' : '#555';
        badgeD.style.backgroundColor = (countDapur > 0) ? 'var(--red)' : '#555';
    }

    function showPage(pageId) {
        activePage = pageId; 
        if (pageId === 'orders') { unreadOrdersCount = 0; localStorage.setItem('sbs_seen_orders', realActiveCount); }
        if (pageId === 'history') { unreadHistoryCount = 0; localStorage.setItem('sbs_seen_history', realHistoryCount); }
        updateNavBadges();
        document.querySelectorAll('.main').forEach(el => el.style.display = 'none');
        document.getElementById(pageId + '-page').style.display = 'block';
        document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
        if(pageId === 'orders') document.querySelectorAll('.menu-item')[0].classList.add('active');
        if(pageId === 'history') document.querySelectorAll('.menu-item')[1].classList.add('active');
    }

    function getDailyQueueNumber(orderId) {
        const targetOrder = allOrders.find(o => o.id === orderId);
        if(!targetOrder) return "00";
        const targetDate = new Date(targetOrder.timestamp).toDateString();
        const dailyOrders = allOrders
            .filter(o => new Date(o.timestamp).toDateString() === targetDate)
            .sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));
        const index = dailyOrders.findIndex(o => o.id === orderId);
        return (index + 1).toString().padStart(2, '0');
    }

    // --- KALKULASI & LIVE UPDATE ---
    function calculateTotals(order, overrideDisc = null) {
        let subtotal = 0;
        if (order.items) {
             order.items.forEach(i => { subtotal += (parseInt(i.price) * parseInt(i.qty)); });
        }
        let discount = (overrideDisc !== null) ? overrideDisc : (order.discount || 0);
        let taxBase = subtotal - discount;
        if (taxBase < 0) taxBase = 0;
        let tax = 0;
        if (isTaxEnabled) tax = Math.ceil(taxBase * 0.1);
        let finalTotal = taxBase + tax;
        if (order.finalData && overrideDisc === null) return order.finalData;
        return { subtotal, discount, tax, finalTotal };
    }

    function updateLiveTotal(orderId) {
        const order = allOrders.find(o => o.id === orderId);
        if (!order) return;
        const inputEl = document.getElementById(`disc-input-${orderId}`);
        const val = inputEl ? parseInt(inputEl.value) : 0;
        const disc = isNaN(val) ? 0 : val;
        const totals = calculateTotals(order, disc);
        const taxRow = document.getElementById(`tax-row-${orderId}`);
        const totalEl = document.getElementById(`total-val-${orderId}`);
        if (taxRow) {
            if (isTaxEnabled && totals.tax > 0) {
                taxRow.style.display = 'flex';
                taxRow.innerHTML = `<span>Tax (10%):</span><span>${totals.tax.toLocaleString()}</span>`;
            } else { taxRow.style.display = 'none'; }
        }
        if (totalEl) totalEl.innerText = `Rp ${totals.finalTotal.toLocaleString()}`;
    }

    function padRow(leftStr, rightStr) {
        const width = 32; 
        const leftLen = leftStr.length;
        const rightLen = rightStr.length;
        const space = width - leftLen - rightLen;
        if (space < 0) return leftStr + " " + rightStr; 
        return leftStr + " ".repeat(space) + rightStr;
    }

    // --- FUNGSI PILIH KASIR (TOMBOL) ---
    function selectCashier(orderId, name) {
        document.getElementById(`selected-cashier-${orderId}`).value = name;
        const container = document.getElementById(`cashier-btn-container-${orderId}`);
        const buttons = container.getElementsByClassName('btn-cashier-select');
        for (let btn of buttons) {
            if (btn.getAttribute('data-name') === name) {
                btn.style.background = 'var(--accent)';
                btn.style.color = '#000';
                btn.style.borderColor = 'var(--accent)';
                btn.style.fontWeight = 'bold';
            } else {
                btn.style.background = '#333';
                btn.style.color = '#ccc';
                btn.style.borderColor = '#555';
                btn.style.fontWeight = 'normal';
            }
        }
        localStorage.setItem('sbs_cashier_name', name);
    }

    // --- PRINTING ---
    function printDirect(id, type) {
        const o = allOrders.find(x => x.id === id); 
        if (!o) return;

        const inputEl = document.getElementById(`disc-input-${id}`);
        const currentDisc = inputEl ? (parseInt(inputEl.value) || 0) : (o.discount || 0);

        const hiddenCashier = document.getElementById(`selected-cashier-${id}`);
        let selectedCashier = o.cashier; 
        if (!selectedCashier && hiddenCashier && hiddenCashier.value) {
            selectedCashier = hiddenCashier.value; 
        }
        if (!selectedCashier) {
            selectedCashier = localStorage.getItem('sbs_cashier_name') || 'Staff'; 
        }

        const q = getDailyQueueNumber(id);
        const totals = calculateTotals(o, currentDisc); 
        const d = new Date(o.timestamp);
        const dateStr = d.toLocaleDateString('en-GB', {day:'2-digit', month:'2-digit', year:'2-digit'}) + " " + d.toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'});
        
        const cName = selectedCashier.toUpperCase(); 
        const custName = (o.customerName || "Customer").toUpperCase();
        const displayID = o.id.slice(-7).toUpperCase();

        const ESC = "\x1B"; const GS = "\x1D"; const INIT = ESC + "@";
        const ALIGN_CENTER = ESC + "a" + "\x01"; const ALIGN_LEFT = ESC + "a" + "\x00"; 
        const BOLD_ON = ESC + "E" + "\x01"; const BOLD_OFF = ESC + "E" + "\x00";
        const TEXT_DOUBLE = GS + "!" + "\x11"; const TEXT_NORMAL = GS + "!" + "\x00";

        let txt = INIT;

        if (type === 'checker') {
            txt += ALIGN_CENTER + BOLD_ON + TEXT_DOUBLE + "CHECKER\n" + TEXT_NORMAL + BOLD_OFF + "\n" + ALIGN_LEFT + "TABLE: " + BOLD_ON + (o.tableNumber || "TA") + BOLD_OFF + "\nQUEUE: #" + q + "\nTIME : " + d.toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'}) + "\nID   : " + displayID + "\n--------------------------------\n";
            o.items.forEach(i => {
                txt += BOLD_ON + i.qty + " x " + i.name + BOLD_OFF + "\n";
                if(i.note) txt += "   [ " + i.note + " ]\n";
                txt += "\n";
            });
            txt += "\n\n\n";

        } else {
            if (type === 'bill') {
                txt += ALIGN_CENTER + BOLD_ON + "THIS IS NOT A RECEIPT\n\n" + BOLD_OFF;
            }

            txt += ALIGN_CENTER + TEXT_DOUBLE + "SBS CAFE\n" + TEXT_NORMAL + "Jl. Mundu 8, Kota Malang\nJawa Timur, 65116\n085159039877\n";
            txt += ALIGN_LEFT + "--------------------------------\n";

            txt += BOLD_ON + "TABLE: " + (o.tableNumber || "TA") + BOLD_OFF + "\n"; 
            txt += "Queue Order: #" + q + "\n";
            txt += "Bill Name: " + custName + "\n"; 
            txt += "Cashier: " + cName + "\n";     
            txt += "Date : " + dateStr + "\n";
            txt += "ID   : " + displayID + "\n";
            
            txt += "--------------------------------\n";

            o.items.forEach(i => {
                let p = parseInt(String(i.price).replace(/[^0-9]/g, '')) || 0;
                let sub = i.qty * p;
                txt += i.name + "\n";
                let leftText = i.qty + "x @" + p.toLocaleString('id-ID'); 
                if (leftText.length < 15) leftText = leftText; 
                let rightText = sub.toLocaleString('id-ID'); 
                txt += padRow(leftText, rightText) + "\n";
                if(i.note) txt += "  (" + i.note + ")\n";
            });
            
            txt += "--------------------------------\n";

            if (!isTaxEnabled && totals.discount === 0) {
                 txt += "\n" + BOLD_ON + padRow("TOTAL", totals.finalTotal.toLocaleString('id-ID')) + BOLD_OFF + "\n";
            } 
            else {
                txt += padRow("Subtotal", totals.subtotal.toLocaleString('id-ID')) + "\n";
                if (totals.discount > 0) txt += padRow("Disc", "- " + totals.discount.toLocaleString('id-ID')) + "\n";
                if (totals.tax > 0) txt += padRow("Tax (10%)", totals.tax.toLocaleString('id-ID')) + "\n";
                txt += "\n" + BOLD_ON + padRow("TOTAL", totals.finalTotal.toLocaleString('id-ID')) + BOLD_OFF + "\n";
            }
            
            txt += "--------------------------------\n";
            txt += ALIGN_CENTER + "\nWifi: SBSkopi8\nTerima Kasih!\n\n\n\n";
        }

        const buffer = new Uint8Array(txt.length);
        for (let i = 0; i < txt.length; i++) { buffer[i] = txt.charCodeAt(i); }
        let binary = '';
        for (let i = 0; i < buffer.byteLength; i++) { binary += String.fromCharCode(buffer[i]); }
        window.location.href = "rawbt:base64," + btoa(binary);
    }

    // --- PROSES PESANAN ---
    function verifyAndPrint(key, btn) {
        const order = allOrders.find(o => o.id === key);
        if(!order) return;

        const inputEl = document.getElementById(`disc-input-${key}`);
        const discountVal = inputEl ? (parseInt(inputEl.value) || 0) : 0;
        
        const hiddenCashier = document.getElementById(`selected-cashier-${key}`);
        const selectedCashier = (hiddenCashier && hiddenCashier.value) ? hiddenCashier.value : (localStorage.getItem('sbs_cashier_name') || 'Staff');

        const currentData = calculateTotals(order, discountVal);
        const card = btn.closest('.order-card');
        if (card) card.classList.add('fade-out');
        
        localStorage.setItem('sbs_cashier_name', selectedCashier);

        setTimeout(() => { 
            db.ref('orders/' + key).update({
                status: 'processing',
                paidAt: new Date().toISOString(),
                cashier: selectedCashier,
                discount: discountVal,
                finalData: {
                    subtotal: currentData.subtotal,
                    discount: discountVal,
                    tax: currentData.tax,
                    finalTotal: currentData.finalTotal,
                    taxEnabledAtPrint: isTaxEnabled 
                },
                total: currentData.finalTotal 
            }); 
        }, 500);
    }

    function finishOrder(key, btn) {
        const card = btn.closest('.order-card');
        if (card) card.classList.add('fade-out');
        setTimeout(() => { updateStatus(key, 'completed'); }, 500);
    }

    function updateStatus(key, status, cashierName = null) {
        const updates = { status: status };
        const now = new Date().toISOString(); 
        if(status === 'unpaid') updates.acceptedAt = now; 
        if(status === 'processing') updates.paidAt = now; 
        if(status === 'completed' || status === 'rejected') updates.completedAt = now; 
        if(cashierName) updates.cashier = cashierName;
        db.ref('orders/' + key).update(updates);
    }
    
    function confirmReject(key) { 
        const hiddenCashier = document.getElementById(`selected-cashier-${key}`);
        const selectedCashier = (hiddenCashier && hiddenCashier.value) ? hiddenCashier.value : (localStorage.getItem('sbs_cashier_name') || 'Staff');

        document.getElementById('confirm-msg').innerText = "Yakin tolak pesanan ini?";
        confirmCallback = () => updateStatus(key, 'rejected', selectedCashier);
        document.getElementById('custom-confirm-modal').style.display = 'flex';
    }

    function deleteOrderItem(orderKey, itemIndex) {
        document.getElementById('confirm-msg').innerText = "Hapus item ini?";
        confirmCallback = () => {
            const order = allOrders.find(o => o.id === orderKey);
            const newItems = [...order.items];
            newItems.splice(itemIndex, 1);
            db.ref('orders/' + orderKey).update({ items: newItems });
        };
        document.getElementById('custom-confirm-modal').style.display = 'flex';
    }

    function filterTab(status) {
        currentTab = status;
        localStorage.setItem('sbs_active_tab', status);
        setupTabs(); renderOrders(); updateTabBadges(); 
    }
    
    function setupTabs() {
        document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
        const activeEl = document.getElementById('tab-' + currentTab);
        if(activeEl) activeEl.classList.add('active');
    }

    function closeConfirm() { document.getElementById('custom-confirm-modal').style.display = 'none'; }
    document.getElementById('btn-confirm-yes').onclick = () => { confirmCallback(); closeConfirm(); };

    setInterval(() => {
        document.querySelectorAll('.live-timer').forEach(el => {
            const startTime = parseInt(el.getAttribute('data-start'));
            if (!startTime || isNaN(startTime)) { el.innerText = "--:--"; return; }
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            if (elapsed > 86400) { el.innerText = "> 24h"; return; }
            const min = Math.floor(elapsed / 60); const sec = elapsed % 60;
            el.innerText = `‚è± ${min}:${sec < 10 ? '0'+sec : sec}`;
        });
        if (audioUnlocked) {
            const now = Date.now();
            if (allOrders.some(order => {
                if (['new', 'pending_payment'].includes(order.status)) {
                    const diff = (now - new Date(order.timestamp).getTime()) / 1000;
                    return diff > 120 && (diff % 120) < 1.5;
                }
                return false;
            })) { soundNag.currentTime = 0; soundNag.play().catch(e => {}); }
        }
    }, 1000);

    function renderOrders() {
        const grid = document.getElementById('orders-grid');
        const historyGrid = document.getElementById('history-grid');
        grid.innerHTML = ''; historyGrid.innerHTML = '';
        const today = new Date().toDateString();

        allOrders.forEach(order => {
            const card = createCard(order);
            const isDone = ['completed', 'rejected', 'done'].includes(order.status);
            if (isDone) {
                if (new Date(order.completedAt || order.timestamp).toDateString() === today) historyGrid.appendChild(card);
            } else {
                if (currentTab === 'kasir') {
                    if (['new', 'unpaid', 'qris_unpaid', 'pending_payment'].includes(order.status)) grid.appendChild(card);
                } else if (currentTab === 'dapur') {
                    if (order.status === 'processing') grid.appendChild(card);
                }
            }
        });
    }

    function createCard(order) {
        let displayName = order.tableNumber ? ("MEJA " + order.tableNumber + (order.customerName ? " - " + order.customerName.toUpperCase() : "")) : order.customer;
        const t1 = new Date(order.timestamp).getTime();
        const t3 = order.paidAt ? new Date(order.paidAt).getTime() : 0;
        let timerStart = (['new', 'qris_unpaid', 'pending_payment', 'unpaid'].includes(order.status)) ? t1 : (order.status === 'processing' ? t3 : 0);
        
        const finance = calculateTotals(order);
        const div = document.createElement('div');
        div.className = `order-card status-${order.status}`;
        if(order.status === 'qris_unpaid') div.style.borderLeftColor = '#888';
        if(order.status === 'pending_payment') div.style.borderLeftColor = '#e67e22'; 
        if(order.status === 'unpaid') div.style.borderLeftColor = '#FF6600'; 
        
        // --- 1. ITEM LIST ---
        let itemsHtml = (order.items || []).map((item, idx) => {
            const qty = parseInt(item.qty); const price = parseInt(item.price);
            const trashBtn = !['completed', 'rejected', 'processing'].includes(order.status) ? `<button class="btn-trash" onclick="deleteOrderItem('${order.id}', ${idx})">üóë</button>` : '';
            return `<div class="item-row"><div style="flex:1;"><span class="item-name">${qty}x ${item.name}</span>${qty > 1 ? `<span class="item-unit-price">(${qty} x ${price.toLocaleString()})</span>` : ''}${item.note ? `<span class="item-note">üìù ${item.note}</span>` : ''}</div><div style="text-align:right;"><span class="item-price">${(qty*price).toLocaleString()}</span>${trashBtn}</div></div>`;
        }).join('');

        const dateStr = new Date(t1).toLocaleDateString('id-ID', {weekday:'short', day:'numeric', month:'short'});
        const timeIn = new Date(t1).toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'});
        let paymentBadge = order.paymentMethod === 'qris' ? '<span style="background:#000; color:#fff; padding:2px 6px; border-radius:4px; font-size:10px; margin-right:5px;">QRIS</span>' : '<span style="background:#ddd; color:#000; padding:2px 6px; border-radius:4px; font-size:10px; margin-right:5px;">TUNAI</span>';

        // --- 2. HEADER RIGHT (TANGGAL & WAKTU) ---
        let headerRight = `<div class="header-right"><span class="meta-date">${dateStr}</span><div class="meta-time-block"><span class="time-label">Masuk:</span> <span class="time-val">${timeIn}</span></div><div class="timer-badge live-timer" data-start="${timerStart}">--:--</div></div>`;
        
        // UPDATE KHUSUS RIWAYAT (Completed/Rejected)
        if(order.status === 'completed' || order.status === 'rejected') {
            // Jam Masuk = Waktu Customer Bayar (paidAt)
            const tPaid = order.paidAt ? new Date(order.paidAt) : new Date(order.timestamp);
            const timePaidStr = tPaid.toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'});
            const timeDoneStr = new Date(order.completedAt).toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'});

            headerRight = `
            <div class="header-right">
                <span class="meta-date">${dateStr}</span>
                <div class="meta-time-block">
                    <span class="time-label">Masuk:</span> <span style="color:#ddd; font-weight:700;">${timePaidStr}</span>
                </div>
                <div class="meta-time-block">
                    <span class="time-label">Selesai:</span> <span class="time-highlight">${timeDoneStr}</span>
                </div>
            </div>`;
        }

        let printButtons = '';
        if(order.status !== 'rejected') {
            const btnStyle = "flex:1;";
            let btnBill = (['new', 'unpaid', 'pending_payment', 'qris_unpaid', 'processing'].includes(order.status)) ? `<button class="btn-print" style="${btnStyle} background:#e67e22; border-color:#d35400;" onclick="printDirect('${order.id}', 'bill')"><span style="font-size:16px;">üìÑ</span> BILL</button>` : '';
            printButtons = `<div class="btn-print-group">${`<button class="btn-print" style="${btnStyle}" onclick="printDirect('${order.id}', 'checker')"><span style="font-size:16px;">üñ®</span> CHECKER</button>`}${btnBill}${`<button class="btn-print" style="${btnStyle}" onclick="printDirect('${order.id}', 'invoice')"><span style="font-size:16px;">üßæ</span> RECEIPT</button>`}</div>`;
        }

        let buttonsHtml = '';
        const btnTolak = `<button class="btn btn-red" onclick="confirmReject('${order.id}')">TOLAK</button>`;
        if (order.status === 'new') buttonsHtml = `<div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">${btnTolak}<button class="btn btn-blue" onclick="verifyAndPrint('${order.id}', this)">LUNAS & PROSES</button></div>`;
        else if (order.status === 'qris_unpaid') buttonsHtml = `<div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">${btnTolak}<button class="btn btn-grey" disabled style="opacity:0.5;">MENUNGGU PEMBAYARAN</button></div><div style="text-align:center; font-size:10px; color:#FF6600; font-weight:bold; margin-top:5px;">‚ö† CUSTOMER BELUM BAYAR</div>`;
        else if (order.status === 'pending_payment') buttonsHtml = `<div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">${btnTolak}<button class="btn btn-blue" onclick="verifyAndPrint('${order.id}', this)">VERIFIKASI & PROSES</button></div><div style="text-align:center; font-size:10px; color:#e67e22; font-weight:bold; margin-top:5px;">‚ö† CEK MUTASI!</div>`;
        else if (order.status === 'processing') buttonsHtml = `<button class="btn btn-green btn-full" onclick="finishOrder('${order.id}', this)">SELESAI & ANTAR</button>`;

        let statusFooter = order.status === 'rejected' ? `<div class="status-footer"><div class="stamp-rejected">DITOLAK ‚úï</div></div>` : (order.status === 'completed' ? `<div class="status-footer"><div class="status-text-done">SELESAI</div></div>` : '');

        const isEditable = ['new', 'unpaid', 'pending_payment', 'qris_unpaid'].includes(order.status);
        
        // --- 3. INPUTS (DISC & KASIR) ---
        let discInputHtml = '';
        let cashierInputHtml = '';
        
        if(isEditable) {
            // Disc
            discInputHtml = `
            <div style="margin:5px 0; border-top:1px dashed #444; padding-top:5px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span style="font-size:12px; color:#aaa;">Disc (Rp):</span>
                    <input type="number" id="disc-input-${order.id}" value="${order.discount||0}" oninput="updateLiveTotal('${order.id}')" style="width:100px; background:#222; border:1px solid #555; color:#fff; padding:4px; border-radius:4px; text-align:right;">
                </div>
            </div>`;

            // Kasir (LABEL: KASIR)
            cashierInputHtml = `<div style="margin-top:10px; border-top:1px dashed #444; padding-top:10px;">
                <div style="font-size:12px; color:#aaa; margin-bottom:3px;">KASIR:</div>
                <div id="cashier-btn-container-${order.id}" style="display:flex; gap:5px; flex-wrap:wrap;">`;
            
            const memoryCashier = localStorage.getItem('sbs_cashier_name');
            cashierList.forEach((name, index) => {
                let isActive = false;
                if (order.cashier) { isActive = (order.cashier === name); }
                else if (memoryCashier) { isActive = (memoryCashier === name); }
                else { isActive = (index === 0); }

                const bg = isActive ? 'var(--accent)' : '#333';
                const col = isActive ? '#000' : '#ccc';
                const border = isActive ? 'var(--accent)' : '#555';
                const fw = isActive ? 'bold' : 'normal';
                
                cashierInputHtml += `<button class="btn-cashier-select" data-name="${name}" onclick="selectCashier('${order.id}', '${name}')" style="background:${bg}; color:${col}; border:1px solid ${border}; padding:6px 10px; border-radius:6px; font-size:11px; cursor:pointer; flex:1; font-weight:${fw};">${name}</button>`;
            });
            let defaultVal = order.cashier || memoryCashier || (cashierList.length > 0 ? cashierList[0] : '');
            cashierInputHtml += `</div><input type="hidden" id="selected-cashier-${order.id}" value="${defaultVal}"></div>`;

        } else if (finance.discount > 0) {
             discInputHtml = `<div style="display:flex; justify-content:space-between; color:#e74c3c; margin-bottom:5px;"><span>Disc:</span><span>- ${finance.discount.toLocaleString()}</span></div>`;
        }

        // --- 4. TOTAL ---
        let totalDisplayHtml = `
            <div style="border-top:1px dashed #444; margin-top:10px; padding-top:5px; font-size:13px; color:#aaa;">
                <div style="display:flex; justify-content:space-between;"><span>Subtotal:</span><span>${finance.subtotal.toLocaleString()}</span></div>
                ${discInputHtml}
                <div id="tax-row-${order.id}" style="display:${(isTaxEnabled && finance.tax > 0) ? 'flex' : 'none'}; justify-content:space-between;"><span>Tax (10%):</span><span>${finance.tax.toLocaleString()}</span></div>
                <div style="display:flex; justify-content:space-between; margin-top:5px; font-weight:600; color:var(--accent); font-size:18px;">
                    <span>Total:</span><span id="total-val-${order.id}">Rp ${finance.finalTotal.toLocaleString()}</span>
                </div>
            </div>
        `;

        let headerCashierHtml = '';
        if(order.cashier) {
            headerCashierHtml = `<div style="font-size:11px; color:#888; margin-top:2px;">Cashier: ${order.cashier}</div>`;
        }

        // --- 5. KPI DURASI ---
        let kpiHtml = '';
        if (order.status === 'completed') {
            const t1 = new Date(order.timestamp).getTime();
            const t2 = order.clientPaidAt ? new Date(order.clientPaidAt).getTime() : 0;
            const t3 = order.paidAt ? new Date(order.paidAt).getTime() : 0;
            const t4 = order.completedAt ? new Date(order.completedAt).getTime() : 0;

            let durPesan = 0, durRespon = 0, durMasak = 0, durTotal = 0;

            if (order.paymentMethod === 'qris') {
                if(t2 && t1) durPesan = t2 - t1;
                if(t3 && t2) durRespon = t3 - t2;
                if(t4 && t3) durMasak = t4 - t3;
            } else {
                if(t3 && t1) durPesan = t3 - t1;
                durRespon = 0; 
                if(t4 && t3) durMasak = t4 - t3;
            }
            if(t4 && t1) durTotal = t4 - t1;

            const responColor = durRespon > 180000 ? '#e74c3c' : '#aaa'; 

            kpiHtml = `
            <div style="margin-top:10px; padding-top:10px; border-top:1px dashed #444; font-size:11px;">
                <div style="display:flex; justify-content:space-between; margin-bottom:2px;">
                    <span style="color:#777;">Pesan - Bayar:</span> <span style="color:#ddd;">${fmtDur(durPesan)}</span>
                </div>
                <div style="display:flex; justify-content:space-between; margin-bottom:2px;">
                    <span style="color:#777;">Respon Kasir:</span> <span style="color:${responColor};">${fmtDur(durRespon)}</span>
                </div>
                <div style="display:flex; justify-content:space-between; margin-bottom:2px;">
                    <span style="color:#777;">Masak / Siapkan:</span> <span style="color:#ddd;">${fmtDur(durMasak)}</span>
                </div>
                <div style="margin-top:5px; padding:5px 0; border-top:1px solid #444; border-bottom:1px solid #444; display:flex; justify-content:space-between; font-size:12px;">
                    <span style="color:#aaa; font-weight:bold;">TOTAL DURASI:</span>
                    <span style="color:#FFD200; font-weight:bold;">${fmtDur(durTotal)}</span>
                </div>
            </div>
            <div style="height:15px;"></div>`;
        }

        // --- 6. SUSUNAN HTML ---
        div.innerHTML = `
            <div class="card-header">
                <div class="header-left">
                    <span class="cust-name">${displayName}</span>
                    <div style="margin-top:4px; display:flex; align-items:center;">
                        ${paymentBadge}
                        <span style="font-size:11px; color:#aaa; margin-left:5px; font-family:monospace;">ID: ...${order.id.slice(-4)}</span>
                    </div>
                    <div style="margin-top:2px; font-size:14px; color:#fff; font-weight:400;">Queue No : ${getDailyQueueNumber(order.id)}</div>
                    ${headerCashierHtml}
                </div>
                ${headerRight}
            </div>
            <div class="item-list">${itemsHtml}</div>
            
            ${totalDisplayHtml} 
            ${cashierInputHtml}  ${kpiHtml}
            ${statusFooter}
            ${printButtons}
            <div class="actions" style="display:block;">${buttonsHtml}</div>
        `;
        return div;
    }
</script>
</body>
</html>
