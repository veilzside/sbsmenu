<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SBS Inventory</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* CSS IDENTIK DENGAN ADMIN AGAR FAMILIAR */
        :root { --bg-dark: #1e1e24; --card-bg: #2b2b36; --accent: #FFD200; --text: #eaeaea; --green: #2ecc71; --red: #e74c3c; --blue: #3498db; }
        * { box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background: var(--bg-dark); color: var(--text); margin: 0; padding: 0; display: flex; height: 100vh; overflow: hidden; }
        
        .sidebar { width: 260px; background: #15151a; padding: 20px; display: flex; flex-direction: column; border-right: 1px solid #333; flex-shrink: 0; z-index: 100; }
        .brand { font-family: 'Bebas Neue'; font-size: 40px; color: var(--accent); margin-bottom: 40px; text-align: center; letter-spacing: 2px; }
        .menu-item { padding: 15px; cursor: pointer; border-radius: 10px; margin-bottom: 10px; font-weight: 600; transition: 0.2s; color: #888; display: flex; align-items: center; gap: 10px; }
        .menu-item.active, .menu-item:hover { background: var(--card-bg); color: var(--accent); }
        .menu-icon { font-size: 20px; }

        .main { flex: 1; padding: 20px; overflow-y: auto; position: relative; }
        .page-title { margin:0 0 20px 0; font-family:'Bebas Neue'; color:var(--accent); font-size: 28px; }

        /* TABS */
        .sub-tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid #444; padding-bottom: 10px; overflow-x: auto; }
        .sub-tab { background: transparent; border: 1px solid #555; color: #888; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-size: 12px; font-weight: bold; white-space: nowrap; }
        .sub-tab.active { background: var(--accent); color: #000; border-color: var(--accent); }

        /* TABLES & FORMS */
        .stock-table { width: 100%; border-collapse: collapse; font-size: 13px; margin-bottom:30px; }
        .stock-table th { text-align: left; padding: 12px; background: #222; color: #888; text-transform: uppercase; font-size: 11px; }
        .stock-table td { padding: 12px; border-bottom: 1px solid #333; }
        .badge { padding: 3px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; }
        .badge-unit { background: #444; color: #ccc; }
        .badge-low { background: rgba(231, 76, 60, 0.2); color: var(--red); animation: pulse 2s infinite; }
        .badge-safe { background: rgba(46, 204, 113, 0.1); color: var(--green); }

        .form-group { margin-bottom: 15px; }
        .form-label { display: block; font-size: 12px; color: #888; margin-bottom: 5px; }
        .form-input, .form-select { width: 100%; padding: 12px; background: #15151a; border: 1px solid #444; color: #fff; border-radius: 8px; font-family: 'Poppins'; }
        
        .btn { border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; color: #fff; font-size: 14px; }
        .btn-green { background: var(--green); color: #000; } 
        .btn-accent { background: var(--accent); color: #000; }
        .btn-grey { background: #555; }

        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); align-items: center; justify-content: center; }
        .modal-content { background: var(--card-bg); padding: 25px; border-radius: 15px; width: 90%; max-width: 450px; border: 2px solid var(--accent); }

        @media (max-width: 768px) {
            body { flex-direction: column; }
            .sidebar { width: 100%; height: 60px; flex-direction: row; justify-content: space-around; padding: 5px; }
            .brand { display: none; }
            .menu-item { flex-direction: column; font-size: 10px; gap: 2px; padding: 5px; background: transparent !important; }
        }
        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="brand">SBS STOCK</div>
        <div class="menu-item active" onclick="location.reload()"><span class="menu-icon">üì¶</span><span>Manajemen Stok</span></div>
        </div>

    <div class="main">
        <h2 class="page-title">INVENTORY CONTROL</h2>
        
        <div class="sub-tabs">
            <button class="sub-tab active" onclick="openStockTab('raw')">üì¶ Bahan Mentah</button>
            <button class="sub-tab" onclick="openStockTab('finished')">üçæ Barang Jadi</button>
            <button class="sub-tab" onclick="openStockTab('restock')">üõí Restock (Belanja)</button>
            <button class="sub-tab" onclick="openStockTab('recipe')">üç≤ Mapping Resep</button>
        </div>

        <div id="view-raw" class="stock-view">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <small style="color:#888">Beras, Telur, Gula (Gram/ML)</small>
                <button class="btn btn-accent" onclick="openAddModal('raw')">+ Bahan Mentah</button>
            </div>
            <table class="stock-table">
                <thead><tr><th>Nama</th><th>Stok</th><th>Status</th></tr></thead>
                <tbody id="tbody-raw"></tbody>
            </table>
        </div>

        <div id="view-finished" class="stock-view" style="display:none;">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <small style="color:#888">Minuman Botol, Rokok (Pcs)</small>
                <button class="btn btn-accent" onclick="openAddModal('finished')">+ Barang Jadi</button>
            </div>
            <table class="stock-table">
                <thead><tr><th>Nama</th><th>Stok</th><th>Status</th></tr></thead>
                <tbody id="tbody-finished"></tbody>
            </table>
        </div>

        <div id="view-restock" class="stock-view" style="display:none;">
            <div style="background:var(--card-bg); padding:20px; border-radius:15px; border:1px solid #444; max-width:500px;">
                <h3 style="margin-top:0; color:var(--accent)">Input Belanja Harian</h3>
                <div class="form-group">
                    <label class="form-label">Kategori</label>
                    <select id="restock-type" class="form-select" onchange="loadRestockItems()">
                        <option value="raw">Bahan Mentah</option>
                        <option value="finished">Barang Jadi</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Nama Barang</label>
                    <select id="restock-item-select" class="form-select"></select>
                </div>
                <div class="form-group">
                    <label class="form-label">Jumlah Dibeli</label>
                    <input type="number" id="restock-qty" class="form-input" placeholder="Contoh: 1000">
                </div>
                <div class="form-group">
                    <label class="form-label">Total Rupiah Belanja</label>
                    <input type="number" id="restock-total" class="form-input" placeholder="Contoh: 15000">
                </div>
                <button class="btn btn-green" onclick="submitRestock()">Simpan & Update Stok</button>
            </div>
        </div>

        <div id="view-recipe" class="stock-view" style="display:none;">
            <div style="background:var(--card-bg); padding:20px; border-radius:15px; border:1px solid #444; max-width:600px;">
                <h3 style="margin-top:0; color:var(--accent)">Mapping Resep</h3>
                <div class="form-group">
                    <label class="form-label">Pilih Menu</label>
                    <select id="recipe-menu-select" class="form-select" onchange="loadRecipeDetails()"></select>
                </div>
                <div id="recipe-ingredients-list" style="margin-bottom:20px;"></div>
                
                <div class="form-group" style="display:flex; gap:5px;">
                    <select id="add-ing-source" class="form-select" style="width:120px;" onchange="loadIngOptions()">
                        <option value="raw">Bahan Mentah</option>
                        <option value="finished">Barang Jadi</option>
                    </select>
                    <select id="add-ing-select" class="form-select"></select>
                    <input type="number" id="add-ing-qty" class="form-input" style="width:80px;" placeholder="Qty">
                    <button class="btn btn-grey" onclick="addIngredientToRecipe()">+</button>
                </div>
                <button class="btn btn-green" onclick="saveRecipeMap()" style="width:100%;">Simpan Perubahan Resep</button>
            </div>
        </div>
    </div>

    <div id="modal-add-item" class="modal">
        <div class="modal-content">
            <h3 id="modal-title" style="margin-top:0; color:var(--accent)">Tambah Barang</h3>
            <input type="hidden" id="new-item-type">
            <div class="form-group"><label class="form-label">Nama Barang</label><input type="text" id="new-item-name" class="form-input"></div>
            <div class="form-group"><label class="form-label">Satuan</label><select id="new-item-unit" class="form-select"></select></div>
            <div class="form-group"><label class="form-label">Stok Awal</label><input type="number" id="new-item-stock" class="form-input"></div>
            <div class="form-group"><label class="form-label">Min. Stok (Alert)</label><input type="number" id="new-item-min" class="form-input"></div>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn btn-grey" onclick="document.getElementById('modal-add-item').style.display='none'">Batal</button>
                <button class="btn btn-green" onclick="saveNewItem()">Simpan</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBSp5184dVTy-EER2qOfxeEA9KQOCMFpKo",
            authDomain: "sbs-menu-d1611.firebaseapp.com",
            databaseURL: "https://sbs-menu-d1611-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "sbs-menu-d1611",
            storageBucket: "sbs-menu-d1611.firebasestorage.app",
            messagingSenderId: "530098727952",
            appId: "1:530098727952:web:1bb3072d93be9564fbee95"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let dbRaw=[], dbFinished=[], dbRecipes={};
        let currentRecipeIngredients = [];
        const menuList = ["Kalter", "Obama", "Mangku Koe", "Mangku Ayang", "Barudak", "Sekena Gomes", "Sekena Goput", "Sekena Keren", "Paket Sambat", "Cricket", "Potato Freak", "Uhat Lawik", "Gyozable", "Tahu Julit", "Fressa", "Americano", "Dark Freshly", "Darkberry", "Tubruk Syari", "Hanoi Tears", "Penkopi", "Macch Favorito", "Specta", "Comica", "Rhumpee", "Crush", "Mammy", "Deep Choc", "Schopea", "Creamberry", "Jandu", "Threepi", "Teh Gelies", "Red Bloom", "Yagustea", "Chenteal", "Trustey", "Rindu", "Literally Water", "Bintang Small", "Bintang Radler", "Bintang Large", "Anker Lychee", "Anker Pineapple", "Smirnoff Raspberry", "Smirnoff Green Apple", "Smirnoff Lemon Lyc", "Smirnoff Pink Lem", "Mix Max Anggur", "Mix Max Blue", "Iceland Lychee", "Iceland L. Island", "Api Anggur Hijau"];

        // LOAD DATA
        db.ref('stock_raw').on('value', s => { dbRaw=[]; if(s.val()) Object.keys(s.val()).forEach(k=>dbRaw.push({id:k,...s.val()[k]})); renderStocks(); });
        db.ref('stock_finished').on('value', s => { dbFinished=[]; if(s.val()) Object.keys(s.val()).forEach(k=>dbFinished.push({id:k,...s.val()[k]})); renderStocks(); });
        db.ref('recipes').on('value', s => { dbRecipes=s.val()||{}; });

        // --- LOGGER FUNCTION (RAHASIA) ---
        function logActivity(action, details) {
            const now = new Date();
            const timeStr = now.toLocaleDateString('id-ID') + ' ' + now.toLocaleTimeString('id-ID');
            db.ref('activity_logs').push({
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                timeString: timeStr,
                action: action,
                details: details,
                user: 'Staff/Gudang' // Bisa diganti jika ada login sistem
            });
        }

        // TABS
        function openStockTab(t) {
            document.querySelectorAll('.stock-view').forEach(e=>e.style.display='none');
            document.querySelectorAll('.sub-tab').forEach(e=>e.classList.remove('active'));
            document.getElementById('view-'+t).style.display='block';
            event.currentTarget.classList.add('active');
            if(t==='restock') loadRestockItems();
            if(t==='recipe') { populateMenuDropdown(); loadIngOptions(); }
        }

        // STOCK RENDER
        function renderStocks() {
            const trRaw = document.getElementById('tbody-raw');
            const trFin = document.getElementById('tbody-finished');
            trRaw.innerHTML=''; trFin.innerHTML='';
            
            const createRow = (item) => {
                const isLow = item.stock <= item.min_stock;
                const status = isLow ? `<span class="badge badge-low">LOW: ${item.min_stock}</span>` : `<span class="badge badge-safe">OK</span>`;
                return `<tr><td><b>${item.name}</b> <span class="badge badge-unit">${item.unit}</span></td><td>${parseFloat(item.stock).toLocaleString()}</td><td>${status}</td></tr>`;
            };
            dbRaw.forEach(i=>trRaw.innerHTML+=createRow(i));
            dbFinished.forEach(i=>trFin.innerHTML+=createRow(i));
        }

        // ADD NEW ITEM
        function openAddModal(type) {
            document.getElementById('modal-add-item').style.display='flex';
            document.getElementById('new-item-type').value=type;
            const sel = document.getElementById('new-item-unit');
            sel.innerHTML = type==='raw'?'<option value="gram">Gram</option><option value="ml">ML</option>':'<option value="pcs">Pcs</option>';
            document.getElementById('new-item-name').value='';
            document.getElementById('new-item-stock').value='';
            document.getElementById('new-item-min').value='';
        }

        function saveNewItem() {
            const type=document.getElementById('new-item-type').value;
            const name=document.getElementById('new-item-name').value;
            const unit=document.getElementById('new-item-unit').value;
            const stock=parseFloat(document.getElementById('new-item-stock').value)||0;
            const min=parseFloat(document.getElementById('new-item-min').value)||0;
            if(!name) return alert("Isi nama barang!");

            const path=type==='raw'?'stock_raw':'stock_finished';
            db.ref(path).push({name, unit, stock, min_stock:min, avg_price:0}).then(()=>{
                logActivity('Barang Baru', `Menambah ${name} (${unit}) - Stok Awal: ${stock}`);
                document.getElementById('modal-add-item').style.display='none';
            });
        }

        // RESTOCK
        function loadRestockItems() {
            const type=document.getElementById('restock-type').value;
            const sel=document.getElementById('restock-item-select');
            sel.innerHTML='<option value="">-- Pilih --</option>';
            const src=type==='raw'?dbRaw:dbFinished;
            src.forEach(i=>{ const opt=document.createElement('option'); opt.value=i.id; opt.innerText=i.name; sel.appendChild(opt); });
        }

        function submitRestock() {
            const type=document.getElementById('restock-type').value;
            const id=document.getElementById('restock-item-select').value;
            const qty=parseFloat(document.getElementById('restock-qty').value);
            const total=parseFloat(document.getElementById('restock-total').value);
            if(!id||!qty||!total) return alert("Lengkapi data!");

            const src=type==='raw'?dbRaw:dbFinished;
            const item=src.find(i=>i.id===id);
            const oldStock=parseFloat(item.stock)||0;
            const oldAvg=parseFloat(item.avg_price)||0;
            const newStock=oldStock+qty;
            const newAvg=((oldStock*oldAvg)+total)/newStock;

            db.ref((type==='raw'?'stock_raw':'stock_finished')+'/'+id).update({stock:newStock, avg_price:newAvg}).then(()=>{
                logActivity('Restock', `Belanja ${item.name}: +${qty}${item.unit} (Rp ${total.toLocaleString()})`);
                alert("Restock Berhasil!");
                document.getElementById('restock-qty').value='';
                document.getElementById('restock-total').value='';
            });
        }

        // RECIPE
        function populateMenuDropdown() {
            const sel=document.getElementById('recipe-menu-select');
            if(sel.options.length>1)return;
            menuList.forEach(m=>{ const opt=document.createElement('option'); opt.value=m; opt.innerText=m; sel.appendChild(opt); });
        }
        function loadIngOptions() {
            const type=document.getElementById('add-ing-source').value;
            const sel=document.getElementById('add-ing-select');
            sel.innerHTML='';
            const src=type==='raw'?dbRaw:dbFinished;
            src.forEach(i=>{ const opt=document.createElement('option'); opt.value=i.id; opt.innerText=i.name; sel.appendChild(opt); });
        }
        function loadRecipeDetails() {
            const m=document.getElementById('recipe-menu-select').value;
            currentRecipeIngredients = (dbRecipes[m] && dbRecipes[m].ingredients) ? dbRecipes[m].ingredients : [];
            renderRecipeList();
        }
        function addIngredientToRecipe() {
            const type=document.getElementById('add-ing-source').value;
            const id=document.getElementById('add-ing-select').value;
            const qty=parseFloat(document.getElementById('add-ing-qty').value);
            if(!id||!qty)return;
            const src=type==='raw'?dbRaw:dbFinished;
            const item=src.find(i=>i.id===id);
            currentRecipeIngredients.push({type, id, name:item.name, unit:item.unit, qty});
            renderRecipeList();
        }
        function renderRecipeList() {
            const div=document.getElementById('recipe-ingredients-list');
            div.innerHTML='';
            currentRecipeIngredients.forEach((ing,idx)=>{
                div.innerHTML+=`<div style="background:#222; padding:5px; margin-bottom:5px; border-radius:4px; display:flex; justify-content:space-between; font-size:12px;"><span>${ing.name}</span><span>${ing.qty} ${ing.unit} <span onclick="remIng(${idx})" style="color:red; cursor:pointer; margin-left:10px;">x</span></span></div>`;
            });
        }
        function remIng(idx){ currentRecipeIngredients.splice(idx,1); renderRecipeList(); }
        
        function saveRecipeMap() {
            const m=document.getElementById('recipe-menu-select').value;
            if(!m)return;
            // Di Stok.html, kita tidak update harga jual, hanya update ingredients
            // Ambil harga jual lama jika ada, atau biarkan null (admin yg set harga)
            const oldSell = (dbRecipes[m] && dbRecipes[m].sell_price) ? dbRecipes[m].sell_price : 0;
            
            db.ref('recipes/'+m).set({sell_price: oldSell, ingredients: currentRecipeIngredients}).then(()=>{
                logActivity('Update Resep', `Mengubah komposisi resep untuk menu: ${m}`);
                alert("Resep Tersimpan!");
            });
        }
    </script>
</body>
</html>
